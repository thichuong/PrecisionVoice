services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: precisionvoice
    ports:
      - "8000:8000"
    volumes:
      # Persist uploaded/processed files
      - ./data:/app/data
      # Cache HuggingFace models to avoid re-downloading
      - model_cache:/root/.cache/huggingface
    environment:
      # HuggingFace token (required for pyannote.audio)
      - HF_TOKEN=${HF_TOKEN:-}
      # Model settings
      - WHISPER_MODEL=${WHISPER_MODEL:-suzii/vi-whisper-large-v3-turbo-v1-ct2}
      - DIARIZATION_MODEL=${DIARIZATION_MODEL:-pyannote/speaker-diarization-3.1}
      # Device (auto, cuda, cpu)
      - DEVICE=${DEVICE:-auto}
      # Upload settings
      - MAX_UPLOAD_SIZE_MB=${MAX_UPLOAD_SIZE_MB:-100}
      # Optimization settings
      - NOISE_REDUCTION_LEVEL=${NOISE_REDUCTION_LEVEL:-12.0}
      - ENABLE_LOUDNORM=${ENABLE_LOUDNORM:-True}
      - ENABLE_NOISE_REDUCTION=${ENABLE_NOISE_REDUCTION:-True}
      # VAD settings
      - VAD_THRESHOLD=${VAD_THRESHOLD:-0.5}
      - VAD_MIN_SPEECH_DURATION_MS=${VAD_MIN_SPEECH_DURATION_MS:-250}
      - VAD_MIN_SILENCE_DURATION_MS=${VAD_MIN_SILENCE_DURATION_MS:-500}
      # Clustering settings
      - MERGE_THRESHOLD_S=${MERGE_THRESHOLD_S:-0.5}
      - MIN_SEGMENT_DURATION_S=${MIN_SEGMENT_DURATION_S:-0.3}
    restart: unless-stopped
    # GPU support (uncomment for NVIDIA GPU)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

volumes:
  model_cache:
    name: precisionvoice_model_cache
